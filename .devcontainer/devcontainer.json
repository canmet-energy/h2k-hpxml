// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/universal
{
	"name": "H2K_HPXML",
	"build": {
		"dockerfile": "./Dockerfile",
		"context": "..",
		"args": {
			"PYTHON_VERSION": "3.12",
			"RUBY_VERSION": "3.2.2",
			"RUBY_METHOD": "system"
		}
	},
	"containerEnv": {
		"UV_PROJECT_ENVIRONMENT": "${containerWorkspaceFolder}/.venv",
		"UV_PYTHON_PREFERENCE": "managed"
	},
	"customizations": {
		"vscode": {
			"extensions": [
				"ms-azuretools.vscode-docker",
				"karyfoundation.idf",
				"ms-python.python",
				"ms-python.black-formatter",
				"ms-python.isort",
				"ms-python.mypy-type-checker",
				"mechatroner.rainbow-csv",
				"janisdd.vscode-edit-csv",
				"qwtel.sqlite-viewer",
				"ms-toolsai.jupyter",
				"openai.chatgpt"
			],
			"settings": {
				// Copies ~/.gitconfig (and relevant includes) into the container
				"dev.containers.copyGitConfig": true,
				// Persists host credentials (e.g., Git Credential Manager) for Git in the container
				"dev.containers.persistGitCredentials": true,
				"files.associations": {
					"*.h2k": "xml",
					"*.hpxml": "xml",
					"*.sql": "sqlite"
				},
				"python.terminal.activateEnvironment": true,
				"python.defaultInterpreterPath": "./.venv/bin/python",
				"python.terminal.activateEnvInCurrentTerminal": true,
				"python.terminal.executeInFileDir": false,
				"python.formatting.provider": "black",
				"python.linting.enabled": true,
				"python.linting.mypyEnabled": true,
				"editor.formatOnSave": true,
				"editor.codeActionsOnSave": {
					"source.organizeImports": "explicit"
				},
				"terminal.integrated.profiles.linux": {
					"bash": {
						"path": "/bin/bash",
						"args": [
							"--login"
						]
					}
				},
				"terminal.integrated.defaultProfile.linux": "bash"
			}
		}
	},
	"remoteEnv": {
		// Certificate environment variables now managed by certctl-safe
		// These were removed: NODE_EXTRA_CA_CERTS, SSL_CERT_FILE, REQUESTS_CA_BUNDLE, AWS_CA_BUNDLE, UV_NATIVE_TLS
	},
	"forwardPorts": [
		8080,
		8000,
		3000
	],
	"portsAttributes": {
		"8080": {
			"visibility": "public",
			"protocol": "http",
			"label": "Claude Code Auth"
		},
		"8000": {
			"visibility": "public",
			"protocol": "http",
			"label": "Development Server"
		},
		"3000": {
			"visibility": "public",
			"protocol": "http",
			"label": "Web App"
		}
	},
	"mounts": [
		// AWS credentials support - works for both Windows and Unix-like systems
		"source=${localEnv:HOME}${localEnv:USERPROFILE}/.aws,target=/home/vscode/.aws,type=bind,readonly",
		// Docker socket for Docker-in-Docker support
		"source=/var/run/docker.sock,target=/var/run/docker.sock,type=bind"
	],
	"postCreateCommand": ".devcontainer/scripts/post-create.sh",
	"containerUser": "vscode",
	"remoteUser": "vscode"
}